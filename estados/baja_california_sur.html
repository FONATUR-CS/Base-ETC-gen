<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Baja California Sur – Turismo Comunitario (Versión Mejorada con IA)</title>

  <!-- Mapbox GL -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet"/>
  
  <!-- Estilos y Fuentes Externas -->
  <link href="https://framework-gb.cdn.gob.mx/gm/v3/assets/styles/main.css" rel="stylesheet">
  
  <!-- Librerías de Animación y Gráficos -->
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/evil-charts/dist/evil-charts.min.js"></script>

  <style>
    :root {
      --primary-color: #EA5188;
      --highlight-color: #FFF2D2;
      --card-bg: rgba(0, 76, 66, 0.92);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Noto Sans', system-ui, Arial, sans-serif; color:#fff; background:#000; }

    #main-nav {
      position: fixed; top: 0; left: 0; width: 100%;
      background-image: url('../img/patron2.jpg'); 
      background-size: cover;
      background-position: center;
      color: #fff; z-index: 10000;
      padding: 10px 24px; box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }
    #main-nav ul { list-style: none; display: flex; gap: 1rem; flex-wrap: wrap; }
    #main-nav a { text-decoration:none; color:#555; font-weight:700; padding:6px 8px; border-radius:4px; }
    #main-nav a.active, #main-nav a:hover { background:var(--primary-color); color:#fff; }

    #map { position: fixed; top: 56px; left:0; right:0; height: calc(100vh - 56px); z-index:1; }

    #story-panels {
      position: fixed; top: 56px; left: 0; width: 100vw; height: calc(100vh - 56px);
      display: flex; justify-content: space-between; align-items: flex-start;
      pointer-events: none; z-index: 2;
    }
    #story-main, #story-side {
      width: 420px; min-width: 320px; max-width: 92vw; height: 100%; position: relative;
    }
    #story-main { pointer-events: auto; margin-left: 48px; display: flex; flex-direction: column; gap: 20px; }
    #story-side { pointer-events: none; }

    .story-content, #filter-bar {
      background: var(--card-bg);
      background-image: url('../img/patron1.jpg');
      background-size: cover; background-position: center; background-attachment: fixed;
      padding: 24px; border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 24px 48px rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
      width: 100%;
    }
    #story-main .story-content { margin-top: 28px; }
    #story-side .story-content {
      position: absolute; top: 28px; right: 40px;
      pointer-events: auto; display: none; opacity: 0; transform: scale(0.95);
    }
    #story-side .story-content.active { display: flex; flex-direction: column; align-items: center; }
    
    .story-content h2 {
      font-family: 'Patria', 'Noto Sans', sans-serif; font-size: 1.55rem;
      margin-bottom:.7rem; color:var(--highlight-color); text-align: left; width: 100%;
    }
    .story-content p { font-size: 1.09rem; line-height:1.55; text-align: left; width: 100%;}
    .story-content img { width:100%; height:auto; border-radius:18px; margin-top:16px; }
    .story-content a { color: var(--primary-color); text-decoration: underline; }

    #filter-bar { padding: 15px 18px; display: flex; flex-direction: column; gap: 7px; }
    #filter-bar label { font-size: 0.93rem; color: var(--highlight-color); }
    #filter-bar select, #filter-bar input {
      border-radius: 7px; border: 1px solid var(--primary-color); padding: 5px 10px;
      background: #222; color: var(--highlight-color); font-size: 0.93rem; width: 100%;
    }
    
    .control-button {
      padding: 12px 24px; background: var(--primary-color); color: #fff;
      border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold;
      cursor: pointer; transition: background 0.2s; pointer-events: auto;
      align-self: flex-start;
    }
    .control-button:hover { background: #d13e74; }

    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #000; z-index: 20000;
      display: flex; justify-content: center; align-items: center;
      transition: opacity 0.5s ease-out;
    }

    #dashboard-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
      z-index: 15000; display: none; justify-content: center; align-items: center;
    }
    #dashboard-content {
      background: var(--card-bg); background-image: url('../img/patron1.jpg');
      padding: 30px; border-radius: 22px; width: 90%; max-width: 800px;
      box-shadow: 0 24px 48px rgba(0,0,0,.45);
    }
    #dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    #dashboard-header h2 { color: var(--highlight-color); margin: 0; }
    #close-dashboard-btn { background: none; border: none; color: #fff; font-size: 2rem; cursor: pointer; }
    #chart-container { width: 100%; height: 400px; }

    /* --- INICIA: Estilos para la funcionalidad de Gemini --- */
    .gemini-feature {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        width: 100%;
    }
    .gemini-button {
        background-color: transparent;
        border: 2px solid var(--highlight-color);
        color: var(--highlight-color);
        padding: 10px 15px;
        width: 100%;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .gemini-button:hover {
        background-color: var(--highlight-color);
        color: var(--card-bg);
    }
    .gemini-button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    .gemini-response {
        margin-top: 15px;
        font-style: italic;
        color: #ddd;
        background-color: rgba(0,0,0,0.2);
        padding: 10px;
        border-radius: 8px;
        text-align: left;
    }
     /* --- TERMINA: Estilos para la funcionalidad de Gemini --- */
    
    @media (max-width: 900px) {
      #story-main, #story-side { width: 98vw; margin-left: auto !important; margin-right: auto !important; }
      #story-main { gap: 15px; }
      #story-main .story-content, #story-side .story-content { margin: 15px auto 0 auto; max-width: 96vw; }
      #story-side .story-content { top: 15px; right: 1vw; }
      .control-button { width: 100%; text-align: center; }
    }
  </style>
</head>
<body>
  
  <div id="loading-overlay">
    <lottie-player id="lottie-loader" background="transparent" speed="1" style="width: 300px; height: 300px;" loop autoplay></lottie-player>
  </div>
  
  <script id="lottie-data" type="application/json">
  {"v":"5.7.4","fr":30,"ip":0,"op":150,"w":500,"h":500,"nm":"Map location","ddd":0,"assets":[],"layers":[{"ddd":0,"ind":1,"ty":4,"nm":"BALL","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":1,"k":[{"i":{"x":0.833,"y":0.833},"o":{"x":0.167,"y":0.167},"t":0,"s":[250,150,0],"to":[0,4.167,0]},{"i":{"x":0.833,"y":0.833},"o":{"x":0.167,"y":0.167},"t":45,"s":[250,135,0],"to":[0,0,0]},{"t":75,"s":[250,150,0]}],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ind":0,"ty":"sh","ix":1,"ks":{"a":0,"k":{"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[1.425,-60.339],[1.425,-60.339]],"c":false},"ix":2},"nm":"Path 1","mn":"ADBE Vector Shape - Group","hd":false},{"ty":"el","s":{"a":0,"k":[121.365,121.365],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Group","hd":false},{"ty":"fl","c":{"a":0,"k":[1,1,1,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"nm":"Fill 1","mn":"ADBE Vector Shape - Group","hd":false}],"nm":"Group 1","np":3,"cix":2,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":150,"st":0,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"LOCATION","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[250,150,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"sh","ks":{"a":0,"k":{"i":[[0,0],[3.864,15.119],[0.49,2.158],[0,0],[0,-20.574],[0,0],[2.551,0],[0,0],[-2.551,0],[0,0],[-22.387,0],[0,0]],"o":[[0,0],[-3.864,-15.119],[-0.49,-2.158],[0,0],[0,20.574],[0,0],[-2.551,0],[0,0],[2.551,0],[0,0],[22.387,0],[0,0]],"v":[[-41.071,83.562],[-11.383,38.808],[-2.422,33.007],[0,31.572],[0,-31.572],[-11.666,-43.238],[-16.291,-43.238],[-16.291,-43.238],[16.291,-43.238],[16.291,-43.238],[39.954,-43.238],[43.238,-39.954]],"c":true},"ix":2},"nm":"Path 1","mn":"ADBE Vector Shape - Group","hd":false},{"ty":"sh","ks":{"a":0,"k":{"i":[[0,0],[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0],[0,0]],"v":[[41.071,83.562],[11.383,38.808],[2.422,33.007],[0,31.572]],"c":false},"ix":2},"nm":"Path 2","mn":"ADBE Vector Shape - Group","hd":false},{"ty":"sh","ks":{"a":0,"k":{"i":[[0,0],[-22.387,0],[0,0]],"o":[[0,0],[22.387,0],[0,0]],"v":[[0,-31.572],[31.572,0],[0,31.572]],"c":true},"ix":2},"nm":"Path 3","mn":"ADBE Vector Shape - Group","hd":false},{"ty":"sh","ks":{"a":0,"k":{"i":[[0,20.574],[0,0]],"o":[[0,-20.574],[0,0]],"v":[[43.238,39.954],[43.238,-39.954]],"c":false},"ix":2},"nm":"Path 4","mn":"ADBE Vector Shape - Group","hd":false},{"ty":"sh","ks":{"a":0,"k":{"i":[[0,0]],"o":[[0,0]],"v":[[11.666,-43.238]],"c":false},"ix":2},"nm":"Path 5","mn":"ADBE Vector Shape - Group","hd":false},{"ty":"fl","c":{"a":0,"k":[0.917647058824,0.317647058824,0.533333333333,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"nm":"Fill 1","mn":"ADBE Vector Shape - Group","hd":false}],"nm":"Group 1","np":3,"cix":2,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":150,"st":0,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"SHADOW","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":1,"k":[{"i":{"x":0.833,"y":0.833},"o":{"x":0.167,"y":0.167},"t":0,"s":[250,300,0],"to":[0,1.042,0]},{"i":{"x":0.833,"y":0.833},"o":{"x":0.167,"y":0.167},"t":45,"s":[250,296.25,0],"to":[0,0,0]},{"t":75,"s":[250,300,0]}],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":1,"k":[{"i":{"x":0.833,"y":0.833},"o":{"x":0.167,"y":0.167},"t":0,"s":[100,20,100],"to":[1.042,0,0]},{"i":{"x":0.833,"y":0.833},"o":{"x":0.167,"y":0.167},"t":45,"s":[70,15,100],"to":[0,0,0]},{"t":75,"s":[100,20,100]}],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"el","s":{"a":0,"k":[150,50],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Group","hd":false},{"ty":"fl","c":{"a":0,"k":[0.8,0.8,0.8,1],"ix":4},"o":{"a":0,"k":20,"ix":5},"r":1,"nm":"Fill 1","mn":"ADBE Vector Shape - Group","hd":false}],"nm":"Group 1","np":3,"cix":2,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":150,"st":0,"bm":0}]}
  </script>

  <div id="dashboard-modal">
    <div id="dashboard-content">
      <div id="dashboard-header">
        <h2>Estadísticas por Municipio</h2>
        <button id="close-dashboard-btn">&times;</button>
      </div>
      <div id="chart-container"></div>
    </div>
  </div>

  <nav id="main-nav">
    <ul>
      <li><a href="../index.html">Inicio</a></li>
      <li><a href="baja_california_sur.html" class="active">Baja California Sur</a></li>
      <li><a href="hidalgo.html">Hidalgo</a></li>
      <li><a href="michoacan.html">Michoacán</a></li>
      <li><a href="morelos.html">Morelos</a></li>
      <li><a href="nayarit.html">Nayarit</a></li>
      <li><a href="oaxaca.html">Oaxaca</a></li>
      <li><a href="puebla.html">Puebla</a></li>
      <li><a href="tlaxcala.html">Tlaxcala</a></li>
      <li><a href="veracruz.html">Veracruz</a></li>
    </ul>
  </nav>
  
  <div id="map"></div>
  
  <div id="story-panels">
    <div id="story-main">
      <div class="story-content active">
        <h2>Turismo Comunitario en Baja California Sur</h2>
        <p>Explora los puntos destacados con este mapa interactivo. Puedes moverte libremente por el mapa y dar clic en cada punto de interés.</p>
        <img src="../img/BCS_1.png" alt="Panorámica de Baja California Sur" loading="lazy">
      </div>
      <div id="filter-bar">
        <label for="filter-municipio">Municipio:</label>
        <select id="filter-municipio"><option value="">Todos</option></select>
        <label for="filter-localidad">Localidad:</label>
        <select id="filter-localidad"><option value="">Todas</option></select>
        <label for="filter-nombre">Nombre ETC:</label>
        <input type="text" id="filter-nombre" placeholder="Buscar ETC...">
      </div>
      <button id="volver-inicio-btn" class="control-button">Volver a la vista general</button>
      <button id="stats-btn" class="control-button">Ver Estadísticas</button>
    </div>
    <div id="story-side"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const lottiePlayerData = JSON.parse(document.getElementById('lottie-data').textContent);
        const lottiePlayer = document.getElementById('lottie-loader');
        lottiePlayer.load(lottiePlayerData);
      } catch (e) {
        console.error("Error al cargar la animación Lottie incrustada:", e);
        document.getElementById('loading-overlay').style.display = 'none';
      }
    });

    const ACCESS_TOKEN = 'pk.eyJ1IjoiY2hheXZvbHRhIiwiYSI6ImNsdGRlNml1NDAyaXgyanJ3eXYzdGQ0MmEifQ.VH5UyDCjvPQ1X_KrkkHcZQ';
    const STATE_GEO  = '../data/baja_california_sur.geojson';
    const POINTS_GEO = '../data/Resultados_BCS_59.geojson';
    const ICON_URL   = '../img/eco.svg';

    let map, pointsData, stateBounds;
    let pulseAnim = null, activeId = null, breathingAnim = null;
    let allFeatures = [], lastFilterFeatures = [];

    mapboxgl.accessToken = ACCESS_TOKEN;
    map = new mapboxgl.Map({
      container:'map', style:'mapbox://styles/mapbox/satellite-streets-v12',
      center:[-111.7, 26.5], zoom:5, pitch:0, bearing:0, projection:'globe'
    });
    map.addControl(new mapboxgl.NavigationControl({ visualizePitch:true }), 'top-right');

    map.on('load', async () => {
      try {
        map.addSource('mapbox-dem', { type: "raster-dem", url: "mapbox://mapbox.terrain-rgb" });
        map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });

        const stateResponse = await fetch(STATE_GEO);
        if (!stateResponse.ok) throw new Error(`Error al cargar el GeoJSON del estado: ${stateResponse.status}`);
        const state = await stateResponse.json();
        
        stateBounds = getGeoJSONBounds(state);
        map.addSource('bcs-poly',{ type:'geojson', data: state });
        map.addLayer({ id:'bcs-fill', type:'fill', source:'bcs-poly', paint:{ 'fill-color':'#EA5188', 'fill-opacity':0.18 }});
        map.addLayer({ id:'bcs-line', type:'line', source:'bcs-poly', paint:{ 'line-color':'#EA5188', 'line-width':2 }});

        const pointsResponse = await fetch(POINTS_GEO);
        if (!pointsResponse.ok) throw new Error(`Error al cargar el GeoJSON de los puntos: ${pointsResponse.status}`);
        pointsData = await pointsResponse.json();
        
        allFeatures = pointsData.features.map((f, i) => ({...f, properties: {...f.properties, id: f.properties.id || `feature-${i}`}}));
        lastFilterFeatures = allFeatures;
        map.addSource('bcs-points',{ type:'geojson', data: { type: 'FeatureCollection', features: allFeatures } });

        const img = new Image(32,32);
        img.src = ICON_URL;
        img.onload = () => {
          if (!map.hasImage('eco')) map.addImage('eco', img, { pixelRatio: 2 });
          addPointLayers();
          setupPointClick();
          startBreathingAll();
          animatePointsIn();
          setupFilterBar();
        };
        if (stateBounds) map.fitBounds(stateBounds, { padding: 40, duration: 800 });

      } catch (error) {
        console.error("ERROR CRÍTICO AL CARGAR DATOS:", error);
        alert("No se pudieron cargar los datos del mapa. Revisa la consola (F12) y asegúrate que la estructura de carpetas y los archivos GeoJSON son correctos.");
      } finally {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.opacity = '0';
        setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
      }
    });

    function addPointLayers(){
      map.addLayer({ id:'bcs-symbols', type:'symbol', source:'bcs-points', layout:{ 'icon-image': 'eco', 'icon-size': 3, 'icon-allow-overlap': true } });
      map.addLayer({ id: 'bcs-symbols-active', type: 'symbol', source: 'bcs-points', filter: ['==', ['get','id'], '__none__'], layout: { 'icon-image': 'eco', 'icon-size': 4.2, 'icon-allow-overlap': true } });
      map.addLayer({ id:'bcs-labels', type:'symbol', source:'bcs-points', layout:{ 'text-field': ['get','Nombre de la ETC'], 'text-size': 14, 'text-offset': [0, 2.2], 'text-anchor': 'top' }, paint:{ 'text-color':'#FFF2D2', 'text-halo-color':'#EA5188', 'text-halo-width': 1.5 }, minzoom: 14 });
    }

    function animatePointsIn(){
      let state = { s: 0.2 };
      anime({ targets: state, s: [0.2, 3], duration: 1200, easing: 'easeOutExpo', update: () => map.setLayoutProperty('bcs-symbols', 'icon-size', state.s) });
    }

    function startBreathingAll() {
      if (breathingAnim) breathingAnim.pause();
      let state = { s: 3 };
      breathingAnim = anime({ targets: state, s: [3, 3.7], duration: 1200, direction: 'alternate', easing: 'easeInOutSine', loop: true, update: () => map.setLayoutProperty('bcs-symbols', 'icon-size', state.s) });
    }
    
    function animateCardIn(card) {
      card.style.display = 'flex';
      anime({ targets: card, opacity: [0, 1], scale: [0.95, 1], duration: 500, easing: 'easeOutQuad' });
    }
    function animateCardOut(card) {
      anime({ targets: card, opacity: [1, 0], scale: [1, 0.95], duration: 400, easing: 'easeInQuad', complete: () => card.style.display = 'none' });
    }

    function showSideCard(id) {
      document.querySelectorAll('#story-side .story-content.active').forEach(card => animateCardOut(card));
      const f = allFeatures.find(fe => fe.properties.id == id);
      if (!f) return;
      renderActiveCard(f);
      flyToFeatureId(id);
      startPulseFor(id);
    }

    function renderActiveCard(feature) {
        const sidePanel = document.getElementById('story-side');
        sidePanel.innerHTML = ''; 
        
        const p = feature.properties;
        const escapedNombre = p["Nombre de la ETC"] ? p["Nombre de la ETC"].replace(/'/g, "\\'") : '';
        const escapedMunicipio = p["Municipio"] ? p["Municipio"].replace(/'/g, "\\'") : '';
        const escapedObservacion = p["Observación"] ? p["Observación"].replace(/'/g, "\\'") : '';

        const div = document.createElement('div');
        div.className = 'story-content active';
        div.innerHTML = `
            <h2>${p["Nombre de la ETC"] || "(Sin nombre)"}</h2>
            <p><strong>Municipio:</strong> ${p["Municipio"] || "-"}<br>
            <strong>Localidad:</strong> ${p["Localidad"] || "-"}</p>
            <p><a href="${p.Google || '#'}" target="_blank" rel="noopener noreferrer">Ubicación en Google Maps</a></p>
            ${p.Observación ? `<p><strong>Observación:</strong> ${p.Observación}</p>` : ""}
            <img src="../img/BCS_1.png" alt="${p["Nombre de la ETC"] || ''}" loading="lazy">
            <div class="gemini-feature">
                <button class="gemini-button" onclick="generateDescription(this, '${escapedNombre}', '${escapedMunicipio}', '${escapedObservacion}')">
                    ✨ Generar descripción poética
                </button>
                <div class="gemini-response"></div>
            </div>
        `;
        sidePanel.appendChild(div);
        animateCardIn(div);
    }

    function stopPulse() {
      if (pulseAnim) pulseAnim.pause();
      activeId = null;
      map.setFilter('bcs-symbols-active', ['==', ['get','id'], '__none__']);
    }
    function startPulseFor(id) {
      if (activeId == id) return;
      activeId = id;
      map.setFilter('bcs-symbols-active', ['==', ['get','id'], activeId]);
      if (pulseAnim) pulseAnim.pause();
      const state = { s: 4.2 };
      pulseAnim = anime({ targets: state, s: [4.2, 5.2], duration: 900, direction: 'alternate', easing: 'easeInOutSine', loop: true, update: () => map.setLayoutProperty('bcs-symbols-active', 'icon-size', state.s) });
    }

    function flyToFeatureId(id){
      const f = allFeatures.find(fe => fe.properties.id == id);
      if (f) map.flyTo({ center: f.geometry.coordinates, zoom: 14, pitch: 35, duration: 1400 });
    }

    function getGeoJSONBounds(gj){
      const b = new mapboxgl.LngLatBounds();
      const eachCoord = (coords) => {
        if (typeof coords[0] === 'number') b.extend(coords);
        else coords.forEach(eachCoord);
      };
      if (gj.type === 'FeatureCollection') gj.features.forEach(ft => eachCoord(ft.geometry.coordinates));
      else if (gj.type === 'Feature') eachCoord(gj.geometry.coordinates);
      else if (gj.type === 'Polygon' || gj.type === 'MultiPolygon') eachCoord(gj.coordinates);
      return b;
    }

    function setupPointClick() {
      map.on('click', 'bcs-symbols', e => e.features.length && showSideCard(e.features[0].properties.id));
      map.on('mouseenter', 'bcs-symbols', () => map.getCanvas().style.cursor = 'pointer');
      map.on('mouseleave', 'bcs-symbols', () => map.getCanvas().style.cursor = '');
    }

    document.getElementById('volver-inicio-btn').addEventListener('click', () => {
      document.querySelectorAll('#story-side .story-content.active').forEach(animateCardOut);
      ['filter-municipio', 'filter-localidad', 'filter-nombre'].forEach(id => document.getElementById(id).value = '');
      filtrarYActualizar();
      if (stateBounds) map.fitBounds(stateBounds, { padding: 40, duration: 1200 });
      stopPulse();
    });

    function setupFilterBar() {
      const municipios = [...new Set(allFeatures.map(f => f.properties["Municipio"]))].filter(Boolean).sort();
      llenarSelect(document.getElementById('filter-municipio'), municipios, "Todos");
      document.getElementById('filter-municipio').addEventListener('change', onFilterMunicipio);
      document.getElementById('filter-localidad').addEventListener('change', filtrarYActualizar);
      document.getElementById('filter-nombre').addEventListener('input', filtrarYActualizar);
      onFilterMunicipio(); 
    }

    function llenarSelect(select, items, labelTodos) {
      select.innerHTML = `<option value="">${labelTodos}</option>`;
      items.forEach(it => select.innerHTML += `<option value="${it}">${it}</option>`);
    }

    function onFilterMunicipio() {
      const municipio = document.getElementById('filter-municipio').value;
      const localidades = !municipio
        ? [...new Set(allFeatures.map(f => f.properties["Localidad"]))]
        : [...new Set(allFeatures.filter(f => f.properties["Municipio"] === municipio).map(f => f.properties["Localidad"]))];
      llenarSelect(document.getElementById('filter-localidad'), localidades.filter(Boolean).sort(), "Todas");
      filtrarYActualizar();
    }

    function filtrarYActualizar() {
      const municipio = document.getElementById('filter-municipio').value;
      const localidad = document.getElementById('filter-localidad').value;
      const nombre = document.getElementById('filter-nombre').value.trim().toLowerCase();
      
      lastFilterFeatures = allFeatures.filter(f => {
        const p = f.properties;
        return (!municipio || p["Municipio"] === municipio) &&
               (!localidad || p["Localidad"] === localidad) &&
               (!nombre || p["Nombre de la ETC"]?.toLowerCase().includes(nombre));
      });
      
      map.getSource('bcs-points').setData({ type: 'FeatureCollection', features: lastFilterFeatures });
    }

    // --- INICIA: Lógica para Gemini API ---
    async function generateDescription(button, nombre, municipio, observacion) {
        const responseContainer = button.nextElementSibling;
        button.textContent = 'Generando...';
        button.disabled = true;

        const apiKey = ""; // API key is handled by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const systemPrompt = "Actúas como un guía turístico local y poeta de Baja California Sur. Escribe una descripción corta (2-3 frases), evocadora y poética del siguiente lugar. Usa un lenguaje que inspire a viajar y descubrir. No incluyas el nombre del lugar o municipio en tu respuesta.";
        const userQuery = `Describe el siguiente lugar: Nombre: ${nombre}, Municipio: ${municipio}, Notas: ${observacion}`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (text) {
                responseContainer.innerHTML = text.replace(/\n/g, '<br>');
            } else {
                responseContainer.textContent = 'No se pudo generar una descripción en este momento.';
            }
        } catch (error) {
            console.error('Error fetching Gemini response:', error);
            responseContainer.textContent = 'Error al contactar al servicio de IA. Inténtalo más tarde.';
        } finally {
            button.style.display = 'none'; // Oculta el botón después de usarlo
        }
    }
    // --- TERMINA: Lógica para Gemini API ---

    const statsBtn = document.getElementById('stats-btn');
    const dashboardModal = document.getElementById('dashboard-modal');
    const closeDashboardBtn = document.getElementById('close-dashboard-btn');
    let chartInstance = null;
    
    statsBtn.addEventListener('click', () => {
      if (!allFeatures || allFeatures.length === 0) {
        alert("Los datos aún no están cargados para mostrar estadísticas.");
        return;
      }
      
      const dataByMunicipio = allFeatures.reduce((acc, f) => {
          const municipio = f.properties.Municipio || 'Sin especificar';
          acc[municipio] = (acc[municipio] || 0) + 1;
          return acc;
      }, {});
      
      const chartData = Object.entries(dataByMunicipio).map(([label, value]) => ({ label, value })).sort((a,b) => b.value - a.value);

      if (chartInstance) chartInstance.destroy();
      chartInstance = new evil.Chart(document.getElementById('chart-container'), {
          type: 'bar',
          options: {
              title: { show: false }, legend: { show: false },
              axis: { x: { style: { color: '#eaeaea' } }, y: { style: { color: '#eaeaea' } } },
              series: { style: { bar: { backgroundColor: 'var(--primary-color)', backgroundColorHover: '#d13e74' } } }
          },
          data: chartData
      });
      chartInstance.on('segmentClick', (segment) => {
        if (segment && segment.label) {
            document.getElementById('filter-municipio').value = segment.label;
            onFilterMunicipio(); 
            dashboardModal.style.display = 'none';
        }
      });
      chartInstance.render();
      dashboardModal.style.display = 'flex';
    });

    closeDashboardBtn.addEventListener('click', () => {
      dashboardModal.style.display = 'none';
    });

  </script>
</body>
</html>

